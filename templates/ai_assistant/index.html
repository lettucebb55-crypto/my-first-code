{% extends 'common/base.html' %}
{% load static %}

{% block content %}
<div id="ai-assistant-app">
    <div class="container my-5">
        <!-- 页面标题 -->
        <div class="text-center mb-5">
            <h1 class="display-4 mb-3">
                <i class="fas fa-robot text-primary me-2"></i>AI旅游助手
            </h1>
            <p class="text-muted">输入您想游览的景点，AI将为您规划最佳路线、交通方式和旅游策略</p>
        </div>

        <!-- 主要内容区域 -->
        <div class="row">
            <!-- 左侧：输入区域 -->
            <div class="col-lg-5 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marked-alt me-2"></i>输入景点信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- 景点输入 -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">景点名称（可输入多个，用逗号分隔）</label>
                            <textarea 
                                v-model="scenicInput" 
                                class="form-control" 
                                rows="3" 
                                placeholder="例如：白洋淀, 直隶总督署, 古莲花池"
                                @input="parseScenicSpots">
                            </textarea>
                            <small class="text-muted">已输入 <strong>{% verbatim %}{{ scenicSpots.length }}{% endverbatim %}</strong> 个景点</small>
                        </div>

                        <!-- 查询类型选择 -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">规划类型</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" id="type-general" value="general" v-model="queryType">
                                <label class="btn btn-outline-primary" for="type-general">综合规划</label>
                                
                                <input type="radio" class="btn-check" id="type-route" value="route" v-model="queryType">
                                <label class="btn btn-outline-primary" for="type-route">路线规划</label>
                                
                                <input type="radio" class="btn-check" id="type-transport" value="transport" v-model="queryType">
                                <label class="btn btn-outline-primary" for="type-transport">交通规划</label>
                                
                                <input type="radio" class="btn-check" id="type-strategy" value="strategy" v-model="queryType">
                                <label class="btn btn-outline-primary" for="type-strategy">旅游策略</label>
                            </div>
                        </div>

                        <!-- 额外需求 -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">额外需求（可选）</label>
                            <textarea 
                                v-model="userInput" 
                                class="form-control" 
                                rows="2" 
                                placeholder="例如：希望行程不要太紧张，适合老人和小孩">
                            </textarea>
                        </div>

                        <!-- 提交按钮 -->
                        <button 
                            @click="generatePlan" 
                            :disabled="loading || scenicSpots.length === 0"
                            class="btn btn-primary w-100 btn-lg">
                            <span v-if="loading">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                正在生成规划...
                            </span>
                            <span v-else>
                                <i class="fas fa-magic me-2"></i>生成AI规划
                            </span>
                        </button>

                        <!-- 已选择的景点列表 -->
                        <div v-if="scenicSpots.length > 0" class="mt-3">
                            <label class="form-label fw-bold">已选择景点：</label>
                            <div class="d-flex flex-wrap gap-2">
                                <span v-for="(spot, index) in scenicSpots" :key="index" class="badge bg-info">
                                    {% verbatim %}{{ spot }}{% endverbatim %}
                                    <button 
                                        type="button" 
                                        class="btn-close btn-close-white ms-1" 
                                        @click="removeScenicSpot(index)"
                                        aria-label="删除">
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 历史记录（如果已登录） -->
                <div v-if="isAuthenticated" class="card shadow-sm mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-history me-2"></i>最近查询
                        </h6>
                    </div>
                    <div class="card-body">
                        <div v-if="historyLoading" class="text-center py-3">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        </div>
                        <div v-else-if="history.length > 0">
                            <div 
                                v-for="item in history" 
                                :key="item.id" 
                                class="border-bottom pb-2 mb-2 cursor-pointer"
                                @click="loadHistoryItem(item.id)"
                                style="cursor: pointer;">
                                <div class="d-flex justify-content-between">
                                    <span class="badge bg-primary">{% verbatim %}{{ item.query_type_display }}{% endverbatim %}</span>
                                    <small class="text-muted">{% verbatim %}{{ item.created_at }}{% endverbatim %}</small>
                                </div>
                                <p class="mb-0 mt-1 small">{% verbatim %}{{ item.user_input }}{% endverbatim %}</p>
                            </div>
                            <a href="{% url 'ai_assistant:history' %}" class="btn btn-sm btn-outline-secondary w-100 mt-2">
                                查看全部历史
                            </a>
                        </div>
                        <div v-else class="text-center text-muted py-3">
                            <small>暂无查询历史</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：结果显示区域 -->
            <div class="col-lg-7">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-map text-white me-2"></i>AI规划结果
                        </h5>
                    </div>
                    <div class="card-body" style="max-height: 800px; overflow-y: auto;">
                        <!-- 加载状态 -->
                        <div v-if="loading" class="text-center py-5">
                            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="text-muted">AI正在为您规划最佳路线...</p>
                        </div>

                        <!-- 错误提示 -->
                        <div v-else-if="error" class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>{% verbatim %}{{ error }}{% endverbatim %}
                        </div>

                        <!-- 警告提示（部分景点未找到） -->
                        <div v-if="warning" class="alert alert-warning alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>{% verbatim %}{{ warning }}{% endverbatim %}
                            <button type="button" class="btn-close" @click="warning = null" aria-label="Close"></button>
                        </div>

                        <!-- 结果展示 -->
                        <div v-else-if="planResult">
                            <!-- 操作按钮栏 -->
                            <div v-if="planResult.query_id && isAuthenticated" class="mb-3 d-flex gap-2">
                                <button 
                                    @click="toggleFavorite(planResult.query_id)"
                                    :disabled="favoriteLoading"
                                    :class="['btn', planResult.is_favorite ? 'btn-warning' : 'btn-outline-warning']">
                                    <span v-if="favoriteLoading" class="spinner-border spinner-border-sm me-1"></span>
                                    <i v-else :class="planResult.is_favorite ? 'fas' : 'far'" class="fa-star me-1"></i>
                                    {% verbatim %}{{ planResult.is_favorite ? '已收藏' : '收藏' }}{% endverbatim %}
                                </button>
                                <button 
                                    @click="exportPlan(planResult.query_id)"
                                    class="btn btn-outline-success">
                                    <i class="fas fa-download me-1"></i>导出规划
                                </button>
                            </div>
                            
                            <!-- 景点信息卡片 -->
                            <div v-if="planResult.scenic_spots && planResult.scenic_spots.length > 0" class="mb-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-map-marker-alt text-danger me-2"></i>景点信息
                                </h6>
                                <div class="row g-3">
                                    <div v-for="spot in planResult.scenic_spots" :key="spot.id" class="col-md-6">
                                        <div class="card border">
                                            <div class="card-body p-3">
                                                <h6 class="card-title mb-2">{% verbatim %}{{ spot.name }}{% endverbatim %}</h6>
                                                <p class="card-text small text-muted mb-1">
                                                    <i class="fas fa-map-marker-alt"></i> {% verbatim %}{{ spot.address }}{% endverbatim %}
                                                </p>
                                                <p class="card-text small mb-1">
                                                    <i class="fas fa-ticket-alt"></i> 门票：¥{% verbatim %}{{ spot.ticket_price }}{% endverbatim %}
                                                </p>
                                                <p class="card-text small mb-0">
                                                    <i class="fas fa-clock"></i> {% verbatim %}{{ spot.open_time }}{% endverbatim %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 路线规划 -->
                            <div v-if="planResult.plan.route_plan" class="mb-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-route text-primary me-2"></i>路线规划
                                </h6>
                                <div class="border rounded p-3 bg-light" v-html="formatMarkdown(planResult.plan.route_plan)"></div>
                            </div>

                            <!-- 交通规划 -->
                            <div v-if="planResult.plan.transport_plan" class="mb-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-car text-success me-2"></i>交通规划
                                </h6>
                                <div class="border rounded p-3 bg-light" v-html="formatMarkdown(planResult.plan.transport_plan)"></div>
                            </div>

                            <!-- 旅游策略 -->
                            <div v-if="planResult.plan.strategy_plan" class="mb-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-lightbulb text-warning me-2"></i>旅游策略
                                </h6>
                                <div class="border rounded p-3 bg-light" v-html="formatMarkdown(planResult.plan.strategy_plan)"></div>
                            </div>
                        </div>

                        <!-- 初始提示 -->
                        <div v-else class="text-center py-5 text-muted">
                            <i class="fas fa-robot fa-3x mb-3 opacity-50"></i>
                            <p>请在左侧输入景点信息，点击"生成AI规划"按钮开始</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Vue.js 3 (CDN) -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<!-- Axios for HTTP requests -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!-- Marked for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            scenicInput: '',
            scenicSpots: [],
            queryType: 'general',
            userInput: '',
            loading: false,
            error: null,
            planResult: null,
            warning: null,
            history: [],
            historyLoading: false,
            isAuthenticated: {{ user.is_authenticated|yesno:"true,false" }},
            favoriteLoading: false
        }
    },
    mounted() {
        if (this.isAuthenticated) {
            this.loadHistory();
        }
    },
    methods: {
        parseScenicSpots() {
            // 解析输入的景点，支持中文逗号、英文逗号、换行分隔
            const spots = this.scenicInput
                .split(/[，,\n]/)  // 支持中文逗号（，）和英文逗号（,）
                .map(s => s.trim())
                .filter(s => s.length > 0);
            this.scenicSpots = [...new Set(spots)]; // 去重
        },
        removeScenicSpot(index) {
            this.scenicSpots.splice(index, 1);
            this.scenicInput = this.scenicSpots.join(', ');
        },
        async generatePlan() {
            if (this.scenicSpots.length === 0) {
                this.error = '请至少输入一个景点';
                return;
            }

            this.loading = true;
            this.error = null;
            this.warning = null;
            this.planResult = null;

            try {
                const response = await axios.post('/api/v1/ai-assistant/plan/', {
                    scenic_spots: this.scenicSpots,
                    query_type: this.queryType,
                    user_input: this.userInput
                }, {
                    headers: {
                        'X-CSRFToken': this.getCSRFToken(),
                        'Content-Type': 'application/json'
                    }
                });

                if (response.data.status === 'success') {
                    this.planResult = response.data.data;
                    // 如果有警告信息（部分景点未找到），显示提示
                    if (response.data.data.warning) {
                        this.warning = response.data.data.warning;
                    }
                    // 初始化收藏状态
                    if (this.planResult.query_id && this.isAuthenticated) {
                        this.checkFavoriteStatus(this.planResult.query_id);
                    }
                    // 如果已登录，刷新历史记录
                    if (this.isAuthenticated) {
                        this.loadHistory();
                    }
                } else {
                    this.error = response.data.message || '生成规划失败';
                }
            } catch (error) {
                console.error('Error:', error);
                if (error.response && error.response.data) {
                    this.error = error.response.data.message || '服务器错误';
                } else {
                    this.error = '网络错误，请稍后重试';
                }
            } finally {
                this.loading = false;
            }
        },
        async loadHistory() {
            if (!this.isAuthenticated) return;
            
            this.historyLoading = true;
            try {
                const response = await axios.get('/api/v1/ai-assistant/history/', {
                    headers: {
                        'X-CSRFToken': this.getCSRFToken()
                    }
                });
                if (response.data.status === 'success') {
                    this.history = response.data.data.slice(0, 5); // 只显示最近5条
                }
            } catch (error) {
                console.error('Load history error:', error);
            } finally {
                this.historyLoading = false;
            }
        },
        async loadHistoryItem(queryId) {
            this.loading = true;
            this.error = null;
            try {
                const response = await axios.get(`/api/v1/ai-assistant/query/${queryId}/`, {
                    headers: {
                        'X-CSRFToken': this.getCSRFToken()
                    }
                });
                if (response.data.status === 'success') {
                    const data = response.data.data;
                    this.planResult = {
                        query_id: data.id,
                        is_favorite: data.is_favorite,
                        scenic_spots: data.scenic_spots,
                        plan: {
                            route_plan: data.route_plan,
                            transport_plan: data.transport_plan,
                            strategy_plan: data.strategy_plan
                        }
                    };
                    // 更新输入
                    this.scenicSpots = data.scenic_spots.map(s => s.name);
                    this.scenicInput = this.scenicSpots.join(', ');
                    this.queryType = data.query_type;
                    this.userInput = data.user_input;
                }
            } catch (error) {
                this.error = '加载历史记录失败';
            } finally {
                this.loading = false;
            }
        },
        formatMarkdown(text) {
            if (!text) return '';
            // 简单的Markdown转HTML（使用marked库）
            if (typeof marked !== 'undefined') {
                return marked.parse(text);
            }
            // 如果没有marked库，简单处理换行
            return text.replace(/\n/g, '<br>');
        },
        async toggleFavorite(queryId) {
            if (!this.isAuthenticated) {
                alert('请先登录');
                return;
            }
            
            this.favoriteLoading = true;
            try {
                const isFavorite = this.planResult.is_favorite;
                const method = isFavorite ? 'delete' : 'post';
                const response = await axios[method](`/api/v1/ai-assistant/query/${queryId}/favorite/`, {}, {
                    headers: {
                        'X-CSRFToken': this.getCSRFToken()
                    }
                });
                
                if (response.data.status === 'success') {
                    this.planResult.is_favorite = response.data.is_favorite;
                    // 刷新历史记录
                    this.loadHistory();
                }
            } catch (error) {
                console.error('Toggle favorite error:', error);
                alert('操作失败，请稍后重试');
            } finally {
                this.favoriteLoading = false;
            }
        },
        async checkFavoriteStatus(queryId) {
            if (!this.isAuthenticated || !queryId) return;
            
            try {
                const response = await axios.get(`/api/v1/ai-assistant/query/${queryId}/`, {
                    headers: {
                        'X-CSRFToken': this.getCSRFToken()
                    }
                });
                if (response.data.status === 'success') {
                    if (this.planResult) {
                        this.planResult.is_favorite = response.data.data.is_favorite;
                    }
                }
            } catch (error) {
                console.error('Check favorite status error:', error);
            }
        },
        exportPlan(queryId) {
            if (!this.isAuthenticated) {
                alert('请先登录');
                return;
            }
            // 直接下载文件
            window.location.href = `/api/v1/ai-assistant/query/${queryId}/export/`;
        },
        getCSRFToken() {
            // 从meta标签或cookie获取CSRF token
            const token = document.querySelector('meta[name=csrf-token]');
            if (token) {
                return token.getAttribute('content');
            }
            // 从cookie获取
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    }
}).mount('#ai-assistant-app');
</script>

<style>
.cursor-pointer {
    cursor: pointer;
}
.cursor-pointer:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}

