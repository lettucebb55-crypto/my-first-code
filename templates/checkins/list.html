{% extends 'common/base.html' %}
{% load static %}

{% block title %}我的打卡记录 - 保定旅游网{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <!-- 左侧导航 -->
        <div class="col-lg-3">
            <div class="card">
                <div class="card-body text-center">
                    <img src="{{ user.avatar.url|default:'https://placehold.co/120x120/avatar.png' }}" alt="User Avatar" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;">
                    <h5 class="card-title">{{ user.username }}</h5>
                    <p class="card-text text-muted">{{ user.phone }}</p>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'users:home' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-home me-2"></i>个人中心
                    </a>
                    <a href="{% url 'checkins:list' %}" class="list-group-item list-group-item-action active">
                        <i class="fas fa-map-marker-alt me-2"></i>我的打卡
                    </a>
                    <a href="{% url 'users:favorites' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-heart me-2"></i>我的收藏
                    </a>
                </div>
            </div>
        </div>

        <!-- 右侧内容 -->
        <div class="col-lg-9">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marker-alt me-2 text-primary"></i>我的打卡记录
                        </h5>
                        <a href="{% url 'scenic:list' %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i>去打卡
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 统计信息 -->
                    <div class="row mb-4" id="statsContainer">
                        <div class="col-md-4">
                            <div class="card text-center border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <div class="card-body p-3">
                                    <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                                    <h6 class="mb-1">总打卡数</h6>
                                    <p class="mb-0 fs-4 fw-bold" id="totalCheckins">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center border-0" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                                <div class="card-body p-3">
                                    <i class="fas fa-mountain fa-2x mb-2"></i>
                                    <h6 class="mb-1">打卡景点数</h6>
                                    <p class="mb-0 fs-4 fw-bold" id="totalSpots">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center border-0" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                                <div class="card-body p-3">
                                    <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                                    <h6 class="mb-1">首次打卡</h6>
                                    <p class="mb-0 fs-5 fw-bold" id="firstCheckin">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 打卡列表 -->
                    <div id="checkinListContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>

                    <!-- 分页 -->
                    <nav aria-label="打卡记录分页" id="paginationContainer" style="display: none;">
                        <ul class="pagination justify-content-center" id="paginationList">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let currentPage = 1;
    const pageSize = 10;

    // 加载打卡列表
    function loadCheckins(page = 1) {
        $.ajax({
            url: '/api/v1/checkins/',
            method: 'GET',
            data: {
                page: page,
                page_size: pageSize
            },
            success: function(response) {
                if (response.status === 'success') {
                    displayCheckins(response.data);
                    updateStats(response.data);
                    updatePagination(response.pagination);
                    currentPage = page;
                } else {
                    showError('加载失败：' + response.message);
                }
            },
            error: function(xhr) {
                showError('加载失败，请稍后重试');
            }
        });
    }

    // 显示打卡列表
    function displayCheckins(checkins) {
        const container = $('#checkinListContainer');
        
        if (checkins.length === 0) {
            container.html(`
                <div class="text-center py-5">
                    <i class="fas fa-map-marker-alt fa-4x text-muted mb-3"></i>
                    <p class="text-muted">还没有打卡记录，快去景点打卡吧！</p>
                    <a href="{% url 'scenic:list' %}" class="btn btn-primary">去打卡</a>
                </div>
            `);
            return;
        }

        let html = '<div class="row g-4">';
        checkins.forEach(function(checkin) {
            html += `
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm">
                        ${checkin.main_photo ? `
                            <img src="${checkin.main_photo}" class="card-img-top" alt="${checkin.scenic_spot.name}" style="height: 200px; object-fit: cover;">
                        ` : ''}
                        <div class="card-body">
                            <h6 class="card-title">
                                <a href="/scenic/${checkin.scenic_spot.id}/" class="text-decoration-none">${checkin.scenic_spot.name}</a>
                            </h6>
                            <p class="card-text text-muted small mb-2">
                                <i class="fas fa-map-marker-alt me-1"></i>${checkin.scenic_spot.address || '地址未知'}
                            </p>
                            <p class="card-text small text-muted mb-2">
                                <i class="fas fa-clock me-1"></i>${checkin.checkin_time}
                            </p>
                            ${checkin.notes ? `<p class="card-text small">${checkin.notes}</p>` : ''}
                            ${checkin.photos && checkin.photos.length > 1 ? `
                                <div class="mt-2">
                                    <small class="text-muted"><i class="fas fa-images me-1"></i>共 ${checkin.photos.length} 张照片</small>
                                </div>
                            ` : ''}
                        </div>
                        <div class="card-footer bg-transparent border-0">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCheckin(${checkin.id})">
                                <i class="fas fa-trash me-1"></i>删除
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.html(html);
    }

    // 更新统计信息
    function updateStats(checkins) {
        const totalCheckins = checkins.length;
        const uniqueSpots = new Set(checkins.map(c => c.scenic_spot.id)).size;
        const firstCheckin = checkins.length > 0 ? checkins[checkins.length - 1].checkin_time.split(' ')[0] : '-';
        
        $('#totalCheckins').text(totalCheckins);
        $('#totalSpots').text(uniqueSpots);
        $('#firstCheckin').text(firstCheckin);
    }

    // 更新分页
    function updatePagination(pagination) {
        const container = $('#paginationContainer');
        const list = $('#paginationList');
        
        if (pagination.total_pages <= 1) {
            container.hide();
            return;
        }
        
        container.show();
        list.empty();
        
        // 上一页
        list.append(`
            <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadPage(${pagination.page - 1}); return false;">上一页</a>
            </li>
        `);
        
        // 页码
        for (let i = 1; i <= pagination.total_pages; i++) {
            if (i === pagination.page) {
                list.append(`<li class="page-item active"><span class="page-link">${i}</span></li>`);
            } else {
                list.append(`<li class="page-item"><a class="page-link" href="#" onclick="loadPage(${i}); return false;">${i}</a></li>`);
            }
        }
        
        // 下一页
        list.append(`
            <li class="page-item ${pagination.page === pagination.total_pages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadPage(${pagination.page + 1}); return false;">下一页</a>
            </li>
        `);
    }

    // 加载指定页面
    window.loadPage = function(page) {
        loadCheckins(page);
    };

    // 删除打卡记录
    window.deleteCheckin = function(checkinId) {
        if (!confirm('确定要删除这条打卡记录吗？')) {
            return;
        }
        
        $.ajax({
            url: `/api/v1/checkins/${checkinId}/delete/`,
            method: 'DELETE',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.status === 'success') {
                    alert('删除成功');
                    loadCheckins(currentPage);
                } else {
                    alert('删除失败：' + response.message);
                }
            },
            error: function(xhr) {
                alert('删除失败，请稍后重试');
            }
        });
    };

    // 显示错误
    function showError(message) {
        $('#checkinListContainer').html(`
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </div>
        `);
    }

    // 初始加载
    loadCheckins();
});
</script>
{% endblock %}

