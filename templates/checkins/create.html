{% extends 'common/base.html' %}
{% load static %}

{% block title %}打卡签到 - {{ scenic_spot.name }} - 保定旅游网{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>打卡签到
                    </h4>
                </div>
                <div class="card-body">
                    <!-- 景点信息 -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            {% if scenic_spot.cover_image %}
                            <img src="{{ scenic_spot.cover_image.url }}" alt="{{ scenic_spot.name }}" class="rounded me-3" style="width: 100px; height: 100px; object-fit: cover;">
                            {% endif %}
                            <div>
                                <h5 class="mb-1">{{ scenic_spot.name }}</h5>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ scenic_spot.address }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 打卡表单 -->
                    <form id="checkinForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="scenic_spot_id" value="{{ scenic_spot.id }}">

                        <!-- 打卡照片 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-camera me-2"></i>打卡照片
                                <span class="text-muted small">(可选，可上传多张)</span>
                            </label>
                            <input type="file" class="form-control" id="checkinPhotos" name="photos" multiple accept="image/*">
                            <small class="text-muted">支持上传多张照片，第一张将作为主照片</small>
                            <div id="photoPreview" class="mt-3 row g-2"></div>
                        </div>

                        <!-- 打卡时间 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-clock me-2"></i>打卡时间
                            </label>
                            <input type="datetime-local" class="form-control" id="checkinTime" name="checkin_time">
                            <small class="text-muted">默认当前时间，可手动调整</small>
                        </div>

                        <!-- 位置信息 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-location-arrow me-2"></i>位置信息
                                <span class="text-muted small">(可选)</span>
                            </label>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <input type="number" class="form-control" id="latitude" name="latitude" step="any" placeholder="纬度">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <input type="number" class="form-control" id="longitude" name="longitude" step="any" placeholder="经度">
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="getLocationBtn">
                                <i class="fas fa-crosshairs me-1"></i>获取当前位置
                            </button>
                            <small class="text-muted d-block mt-2">点击按钮自动获取当前位置（需要浏览器授权）</small>
                        </div>

                        <!-- 备注 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-comment me-2"></i>打卡备注
                                <span class="text-muted small">(可选)</span>
                            </label>
                            <textarea class="form-control" id="notes" name="notes" rows="4" placeholder="分享您的游览感受..."></textarea>
                        </div>

                        <!-- 是否公开 -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isPublic" name="is_public" checked>
                                <label class="form-check-label" for="isPublic">
                                    公开此打卡记录（将显示在个人地图中）
                                </label>
                            </div>
                        </div>

                        <!-- 提交按钮 -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-check me-2"></i>确认打卡
                            </button>
                            <a href="{% url 'scenic:detail' pk=scenic_spot.id %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>返回景点详情
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 设置默认时间为当前时间
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    $('#checkinTime').val(now.toISOString().slice(0, 16));

    // 照片预览
    $('#checkinPhotos').on('change', function(e) {
        const files = e.target.files;
        const preview = $('#photoPreview');
        preview.empty();
        
        if (files.length > 0) {
            preview.append('<div class="col-12"><small class="text-muted">已选择 ' + files.length + ' 张照片</small></div>');
        }
        
        Array.from(files).forEach(function(file, index) {
            if (index < 6) { // 最多预览6张
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.append(`
                        <div class="col-md-3">
                            <img src="${e.target.result}" class="img-thumbnail" style="width: 100%; height: 100px; object-fit: cover;">
                        </div>
                    `);
                };
                reader.readAsDataURL(file);
            }
        });
    });

    // 获取当前位置
    $('#getLocationBtn').on('click', function() {
        if (navigator.geolocation) {
            $(this).html('<i class="fas fa-spinner fa-spin me-1"></i>获取中...');
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    $('#latitude').val(position.coords.latitude.toFixed(7));
                    $('#longitude').val(position.coords.longitude.toFixed(7));
                    $('#getLocationBtn').html('<i class="fas fa-check me-1"></i>已获取');
                    setTimeout(function() {
                        $('#getLocationBtn').html('<i class="fas fa-crosshairs me-1"></i>获取当前位置');
                    }, 2000);
                },
                function(error) {
                    alert('获取位置失败：' + error.message);
                    $('#getLocationBtn').html('<i class="fas fa-crosshairs me-1"></i>获取当前位置');
                }
            );
        } else {
            alert('您的浏览器不支持地理位置功能');
        }
    });

    // 提交表单
    $('#checkinForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // 处理多张照片
        const photos = $('#checkinPhotos')[0].files;
        if (photos.length > 0) {
            // 第一张作为主照片
            formData.append('main_photo', photos[0]);
            // 所有照片
            for (let i = 0; i < photos.length; i++) {
                formData.append('photos', photos[i]);
            }
        }

        // 显示加载状态
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>提交中...');

        $.ajax({
            url: '/api/v1/checkins/create/',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.status === 'success') {
                    alert('打卡成功！');
                    window.location.href = '/checkins/list/';
                } else {
                    alert('打卡失败：' + response.message);
                    submitBtn.prop('disabled', false).html(originalText);
                }
            },
            error: function(xhr) {
                let message = '打卡失败，请稍后重试';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                alert(message);
                submitBtn.prop('disabled', false).html(originalText);
            }
        });
    });
});
</script>
{% endblock %}

