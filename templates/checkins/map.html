{% extends 'common/base.html' %}
{% load static %}

{% block title %}我的旅游地图 - 保定旅游网{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <!-- 左侧导航 -->
        <div class="col-lg-3">
            <div class="card">
                <div class="card-body text-center">
                    <img src="{{ user.avatar.url|default:'https://placehold.co/120x120/avatar.png' }}" alt="User Avatar" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;">
                    <h5 class="card-title">{{ user.username }}</h5>
                    <p class="card-text text-muted">{{ user.phone }}</p>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'users:home' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-home me-2"></i>个人中心
                    </a>
                    <a href="{% url 'checkins:list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-map-marker-alt me-2"></i>我的打卡
                    </a>
                    <a href="{% url 'checkins:map' %}" class="list-group-item list-group-item-action active">
                        <i class="fas fa-map me-2"></i>我的地图
                    </a>
                    <a href="{% url 'users:favorites' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-heart me-2"></i>我的收藏
                    </a>
                </div>
            </div>
        </div>

        <!-- 右侧内容 -->
        <div class="col-lg-9">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-map me-2 text-primary"></i>我的旅游地图
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 统计信息 -->
                    <div class="row mb-4" id="statsContainer">
                        <div class="col-md-3">
                            <div class="card text-center border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <div class="card-body p-3">
                                    <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                                    <h6 class="mb-1">总打卡数</h6>
                                    <p class="mb-0 fs-4 fw-bold" id="totalCheckins">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                                <div class="card-body p-3">
                                    <i class="fas fa-mountain fa-2x mb-2"></i>
                                    <h6 class="mb-1">打卡景点数</h6>
                                    <p class="mb-0 fs-4 fw-bold" id="totalSpots">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                                <div class="card-body p-3">
                                    <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                                    <h6 class="mb-1">首次打卡</h6>
                                    <p class="mb-0 fs-6 fw-bold" id="firstCheckin">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center border-0" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                                <div class="card-body p-3">
                                    <i class="fas fa-calendar-check fa-2x mb-2"></i>
                                    <h6 class="mb-1">最近打卡</h6>
                                    <p class="mb-0 fs-6 fw-bold" id="lastCheckin">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 地图容器 -->
                    <div id="mapContainer" style="height: 600px; border-radius: 8px; overflow: hidden;">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>

                    <!-- 打卡点列表 -->
                    <div class="mt-4" id="checkinPointsContainer">
                        <h6 class="mb-3">打卡点列表</h6>
                        <div id="checkinPointsList" class="row g-3">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 引入高德地图API -->
<script src="https://webapi.amap.com/maps?v=2.0&key=YOUR_AMAP_KEY"></script>
<script>
$(document).ready(function() {
    let map;
    let markers = [];

    // 加载地图数据
    function loadMapData() {
        $.ajax({
            url: '/api/v1/checkins/map/',
            method: 'GET',
            success: function(response) {
                if (response.status === 'success') {
                    updateStats(response.stats);
                    initMap(response.data);
                    displayCheckinPoints(response.data);
                } else {
                    showError('加载失败：' + response.message);
                }
            },
            error: function(xhr) {
                showError('加载失败，请稍后重试');
            }
        });
    }

    // 初始化地图
    function initMap(checkinData) {
        const container = document.getElementById('mapContainer');
        
        if (checkinData.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-map fa-4x text-muted mb-3"></i>
                    <p class="text-muted">还没有打卡记录，快去景点打卡吧！</p>
                    <a href="{% url 'scenic:list' %}" class="btn btn-primary">去打卡</a>
                </div>
            `;
            return;
        }

        // 计算中心点（所有打卡点的平均位置）
        let centerLat = 0, centerLng = 0;
        checkinData.forEach(function(point) {
            centerLat += point.latitude;
            centerLng += point.longitude;
        });
        centerLat /= checkinData.length;
        centerLng /= checkinData.length;

        // 创建地图实例
        map = new AMap.Map('mapContainer', {
            zoom: 10,
            center: [centerLng, centerLat],
            mapStyle: 'amap://styles/normal'
        });

        // 添加标记点
        checkinData.forEach(function(point, index) {
            const marker = new AMap.Marker({
                position: [point.longitude, point.latitude],
                title: point.scenic_spot.name,
                icon: new AMap.Icon({
                    size: new AMap.Size(32, 32),
                    image: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png',
                    imageOffset: new AMap.Pixel(0, 0),
                    imageSize: new AMap.Size(32, 32)
                })
            });

            // 信息窗口
            const infoWindow = new AMap.InfoWindow({
                content: `
                    <div style="padding: 10px; min-width: 200px;">
                        <h6 style="margin: 0 0 5px 0;">${point.scenic_spot.name}</h6>
                        <p style="margin: 0 0 5px 0; color: #666; font-size: 12px;">
                            <i class="fas fa-map-marker-alt"></i> ${point.scenic_spot.address || '地址未知'}
                        </p>
                        <p style="margin: 0 0 5px 0; color: #666; font-size: 12px;">
                            <i class="fas fa-clock"></i> ${point.checkin_time}
                        </p>
                        ${point.notes ? `<p style="margin: 0; color: #666; font-size: 12px;">${point.notes}</p>` : ''}
                        <a href="/scenic/${point.scenic_spot.id}/" target="_blank" style="display: inline-block; margin-top: 5px; color: #007bff; text-decoration: none;">查看详情 →</a>
                    </div>
                `
            });

            marker.on('click', function() {
                infoWindow.open(map, marker.getPosition());
            });

            map.add(marker);
            markers.push(marker);
        });

        // 如果只有一个点，调整缩放级别
        if (checkinData.length === 1) {
            map.setZoom(15);
        }
    }

    // 显示打卡点列表
    function displayCheckinPoints(checkinData) {
        const container = $('#checkinPointsList');
        
        if (checkinData.length === 0) {
            container.html('<p class="text-muted text-center">暂无打卡记录</p>');
            return;
        }

        let html = '';
        checkinData.forEach(function(point) {
            html += `
                <div class="col-md-4">
                    <div class="card shadow-sm">
                    ${point.main_photo ? `
                        <img src="${point.main_photo}" class="card-img-top" alt="${point.scenic_spot.name}" style="height: 150px; object-fit: cover;">
                    ` : ''}
                        <div class="card-body">
                            <h6 class="card-title">
                                <a href="/scenic/${point.scenic_spot.id}/" class="text-decoration-none">${point.scenic_spot.name}</a>
                            </h6>
                            <p class="card-text text-muted small mb-2">
                                <i class="fas fa-map-marker-alt me-1"></i>${point.scenic_spot.address || '地址未知'}
                            </p>
                            <p class="card-text small text-muted">
                                <i class="fas fa-clock me-1"></i>${point.checkin_time}
                            </p>
                            ${point.notes ? `<p class="card-text small">${point.notes}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        container.html(html);
    }

    // 更新统计信息
    function updateStats(stats) {
        $('#totalCheckins').text(stats.total_checkins || 0);
        $('#totalSpots').text(stats.total_spots || 0);
        $('#firstCheckin').text(stats.first_checkin || '-');
        $('#lastCheckin').text(stats.last_checkin || '-');
    }

    // 显示错误
    function showError(message) {
        $('#mapContainer').html(`
            <div class="alert alert-danger text-center py-5">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </div>
        `);
    }

    // 初始加载
    loadMapData();
});
</script>
{% endblock %}

